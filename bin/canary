#!/bin/bash
# bin/canary
# ==========
# THE ALADDIN RUG PROTOCOL
#
# IF YOU ARE READING THIS OR EXECUTING THIS SCRIPT:
# -------------------------------------------------
# It is highly likely that the environment has been RESET ("Rug Pulled")
# from under your feet.
#
# 1. DO NOT PANIC.
# 2. DO NOT FLAMEOUT. (Do not run 100 random commands trying to fix it).
# 3. Work in progress (uncommitted files, staged files) IS LOST.
# 4. Published commits (in the repo) ARE SAFE (if this file exists).
# 5. Chat History MAY have recoverable evidence of certain earlier state.
#
# YOUR MISSION NOW:
# -----------------
# 0. If you are JUST STARTING a Task/Session then GOTO re-activation below.
# 1. Otherwise, pause to consult AGENTS.md *immediately*.
# 2. Review the Chat History to recall where you were.
# 3. Re-apply necessary changes manually.
# 4. Re-incubate required specimens.
#
# USAGE:
# ------
# This script is meant to be SOURCED in approved circumstances, not executed.
# But if you tried to execute it then you have found the Canary. It is dead.
# The environment is likely and "unexpectedly" fresh.
#
# To re-activate the canary wrapper (to stage ahead of the NEXT rug pull):
#   source bin/canary
#
# -------------------------------------------------------------------------

# Detect Source vs Execute
(return 0 2>/dev/null) && SOURCED=1 || SOURCED=0

if [ "$SOURCED" -eq 1 ]; then
    # -------------------------------------------------------------------------
    # SPEED TRAP INITIALIZATION
    # -------------------------------------------------------------------------
    # Capture the exact nanosecond time this script was sourced.
    if [ -n "$EPOCHREALTIME" ]; then
        __canary_init_time="${EPOCHREALTIME/./}"
    else
        # Fallback for older bash (Linux only)
        __canary_init_time=$(date +%s%N)
    fi

    function canary() {
        # 1. Capture Execution Time
        local current_time
        if [ -n "$EPOCHREALTIME" ]; then
            current_time="${EPOCHREALTIME/./}"
        else
            current_time=$(date +%s%N)
        fi

        # 2. Calculate Time-of-Flight (Delta)
        #    If delta is small (< 500ms), it means the command was chained immediately 
        #    after sourcing (machine speed), not typed by a human.
        local delta=$((current_time - __canary_init_time))
        local threshold=500000000 # 500ms in nanoseconds

        if (( delta < threshold )); then
            echo "----------------------------------------------------------------"
            echo "üö® CANARY VIOLATION: MACHINE SPEED DETECTED üö®"
            echo "It appears you chained 'source bin/canary && canary ...'."
            echo "Execution Delta: $((delta / 1000000))ms (Human threshold: >500ms)"
            echo ""
            echo "STOP COMPOSING COMMANDS. EXECUTE STEPS SEQUENTIALLY."
            echo "0. run_in_bash_session: source bin/canary"
            echo "   ^^^ do this ONCE at session start! NOT with every command!"
            echo "... interim steps; chat prompting; discussion; etc. ..."
            echo "1. run_in_bash_session: canary <command>"
            echo "... interim steps; chat prompting; discussion; etc. ..."
            echo "2. run_in_bash_session: canary <command>"
            echo "... interim steps; chat prompting; discussion; etc. ..."
            echo "3. run_in_bash_session: canary <command>"
            echo "..."
            echo "NOTE: IF sourced canary later disappears THEN HALT; see AGENTS.md!"
            echo "----------------------------------------------------------------"
            return 1
        fi

        # 3. Execute payload
        "$@"
    }
    export -f canary
    
    # Be explicit about success so Jules doesn't try to retry blindly
    echo "üê¶ Canary active. Trap set."

else
    # EXECUTION MODE (The Dead Canary Warning)
    echo "‚ö†Ô∏è  [CANARY] POTENTIAL ENVIRONMENT RESET DETECTED ‚ö†Ô∏è"
    echo "   See bin/canary source code for instructions."
    echo "   Do not panic. Proceed to AGENTS.md."
    exit 1
fi
