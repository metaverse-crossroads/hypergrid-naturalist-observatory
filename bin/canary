#!/bin/bash
# bin/canary
# ==========
# THE ALADDIN RUG PROTOCOL
#
# IF YOU ARE READING THIS OR EXECUTING THIS SCRIPT:
# -------------------------------------------------
# It is highly likely that the environment has been RESET ("Rug Pulled")
# from under your feet.
#
# 1. DO NOT PANIC.
# 2. DO NOT FLAMEOUT. (Do not run 100 random commands trying to fix it).
# 3. Work in progress (uncommitted files, staged files) IS LOST.
# 4. Published commits (in the repo) ARE SAFE (if this file exists).
# 5. Chat History MAY have recoverable evidence of certain earlier state.
#
# YOUR MISSION NOW:
# -----------------
# 0. If you are JUST STARTING a Task/Session then GOTO re-activation below.
# 1. Otherwise, pause to consult AGENTS.md *immediately*.
# 2. Review the Chat History to recall where you were.
# 3. Re-apply necessary changes manually.
# 4. Re-incubate required specimens.
#
# USAGE:
# ------
# This script is meant to be SOURCED in approved circumstances, not executed.
# But if you tried to execute it then you have found the Canary. It is dead.
# The environment is likely and "unexpectedly" fresh.
#
# To re-activate the canary wrapper (to stage ahead of the NEXT rug pull):
#   source bin/canary
#
# -------------------------------------------------------------------------

# Detect Source vs Execute
(return 0 2>/dev/null) && SOURCED=1 || SOURCED=0

# Anchor the session start time to a file in /tmp.
CANARY_BIRTH_FILE="/tmp/.canary_birth"

if [ "$SOURCED" -eq 1 ]; then
    SCOLDING=
    # -2. Compound cheating detection
    # -----------------------------------------------------------------------------
    # Detects if this script is being sourced as part of a chain (e.g. "source x && y")
    current_invocation=""
    if [ -n "$BASH_EXECUTION_STRING" ]; then
        current_invocation="$BASH_EXECUTION_STRING"
    else
        current_invocation=$(cat /proc/$$/cmdline 2>/dev/null | tr '\0' ' ')
    fi
    cheat_pattern='(\.|source)\s+.*bin/canary.*(\&\&|;|\|)'
    if [[ "$current_invocation" =~ $cheat_pattern ]]; then
            echo "----------------------------------------------------------------"
            echo "üö® CANARY VIOLATION: MACHINE SPEED DETECTED üö®"
            echo "You are attempting to chain 'bin/canary' with other commands."
            echo "Detected Execution: $current_invocation"
            echo ""
            echo "STOP COMPOSING COMMANDS. EXECUTE STEPS SEQUENTIALLY."
            echo "0. run_in_bash_session: source bin/canary"
            echo "   ^^^ do this ONCE at session start! NOT with every command!"
            echo "1. run_in_bash_session: canary <command>"
            echo "----------------------------------------------------------------"
        return 1 2>/dev/null || exit 1
    fi    
    # -------------------------------------------------------------------------
    # SPEED TRAP INITIALIZATION
    # -------------------------------------------------------------------------
    # -1. Sanity Check
    if [ -f "$CANARY_BIRTH_FILE" ]; then
        _ago=$(( ($(date +%s%N) - $(cat "$CANARY_BIRTH_FILE")) / 1000000000 ))
        echo "‚ö†Ô∏è  [CANARY] NOTICE: birth file present; re-sourcing detected in active session." >&2
        echo "   Previous sourcing was ${_ago}s ago." >&2
    fi
    # ALWAYS write the birth time when sourced.
    # This traps "source && canary" because the file is written ms before the check.
    date +%s%N > "$CANARY_BIRTH_FILE"

    function canary() {
        # 0. Safety Check
        if [ ! -f "$CANARY_BIRTH_FILE" ]; then
             echo "‚ö†Ô∏è  [CANARY] FATAL: Session state lost (birth file missing)."
             echo "   You may need to re-initialize: source bin/canary"
             return 1
        fi

        # 1. Capture Execution Time (Now)
        local current_time=$(date +%s%N)

        # 2. Read Birth Time (Then)
        local birth_time=$(cat "$CANARY_BIRTH_FILE")

        # 3. Calculate Time-of-Flight (Delta)
        local delta=$((current_time - birth_time))
        local threshold=500000000 # 500ms in nanoseconds

        if (( delta < threshold )); then
            echo "----------------------------------------------------------------"
            echo "üö® CANARY VIOLATION: MACHINE SPEED DETECTED üö®"
            echo "It appears you chained 'source bin/canary && canary ...'."
            echo "Execution Delta: $((delta / 1000000))ms (Human threshold: >500ms)"
            echo ""
            echo "STOP COMPOSING COMMANDS. EXECUTE STEPS SEQUENTIALLY."
            echo "0. run_in_bash_session: source bin/canary"
            echo "   ^^^ do this ONCE at session start! NOT with every command!"
            echo "1. run_in_bash_session: canary <command>"
            echo "----------------------------------------------------------------"
            return 1
        fi

        # 4. Execute payload
        "$@"
    }
    export -f canary

    echo "üê¶ Canary active. Trap set."

else
    # EXECUTION MODE
    echo "----------------------------------------------------------------"
    echo "üö® [CANARY] VIOLATION: DIRECT INVOCATION DETECTED üö®"
    echo ""
    if ! test -v OBSERVATORY_ENV_DIR ; then
        echo "It appears you attempted to directly run 'bin/canary'"
        echo "‚ö†Ô∏è [CANARY] POTENTIAL ENVIRONMENT RESET DETECTED  ‚ö†Ô∏è"
        echo ""
    fi
    echo "   See bin/canary source code for instructions."
    echo "   Do not panic. Proceed to AGENTS.md."
    exit 1
fi
