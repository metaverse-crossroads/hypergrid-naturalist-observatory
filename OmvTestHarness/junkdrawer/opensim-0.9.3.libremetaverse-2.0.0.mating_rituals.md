# OpenSim Client/Server Mating Rituals

*This document captures the "DX story" of the connection sequence between an OpenSim Server and a LibreMetaverse Client, as observed by a neutral 3rd party observer.*

## Prologue: The Environment
- **Server**: OpenSim (Instrumented)
- **Client**: LibreMetaverse Test Harness
- **Protocol**: HTTP (XML-RPC) & UDP

---

## Part I: The Knock at the Gate (Login)
**Context**: The Client is outside the grid, seeking entry. It communicates via HTTP/XML-RPC to the Login Service.

1.  **The Approach**: The Client approaches the Login Service, presenting credentials (Name: "Test User") and identifying its Viewer software.
2.  **The Validation**: The Server receives the request and validates the credentials against the User Account Service. Authentication is successful.
3.  **Circuit Provisioning**: The Server prepares a "Circuit" for the agent. This is a reserved slot on a specific Region Server. A unique `CircuitCode` (e.g., `882763467`) is generated as a ticket.
4.  **Granting Entry**: The Server responds to the Client's HTTP request. The response contains the `CircuitCode`, the IP address of the Region Server, and the `SessionID`. The Client is now authorized but not yet connected to the physical simulation.

## Part II: The Handshake (UDP Connection)
**Context**: The Client now has a ticket (`CircuitCode`) and knows where to go. It switches to the UDP protocol to establish a real-time connection with the Region Server.

1.  **Initiating Connection**: The Client sends a `UseCircuitCode` packet to the Region Server's UDP port. This packet contains the `CircuitCode` received in Part I.
2.  **Verification**: The Region Server receives the packet. It checks the `CircuitCode` against its list of expected arrivals (provisioned in Part I).
3.  **Acceptance**: The Server validates the code. The UDP connection is now "established". The Server knows which Agent belongs to this IP endpoint.

## Part III: The Revelation (Region Handshake)
**Context**: The connection is open, but the Client knows nothing about the world it has entered.

1.  **Extending the Hand**: The Server sends a `RegionHandshake` packet.
    - **Content**: This packet describes the fundamental rules of the region (e.g., "No Fly", "Allow Damage"), the terrain height range, and the region ID.
2.  **Acknowledgment**: The Client receives this and adjusts its internal state to match the region's parameters. It typically replies to confirm receipt.

## Part IV: The Materialization (Entry)
**Context**: The Client is connected and knows the rules. It is time to physically manifest the avatar in the simulation.

1.  **Placement**: The Server calculates the Avatar's starting position (often `128, 128` or the last known location).
2.  **The Command**: The Server sends the `AgentMovementComplete` (or similar) packet sequence, instructing the Client: "You are here."
    - **Position**: `<128, 128, 26.03>`
    - **LookAt**: `<0.99, 0.042, 0>`
3.  **Rendering**: Following this, the Server begins the stream of `LayerData` (Terrain) and `ObjectUpdate` packets to paint the world around the Avatar.

---

*Generated by MatingRitualLogger instrumentation.*
